<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Clinical Intelligence | High Fidelity</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #0f4c81;
            --primary-light: #e6f0f9;
            --secondary: #00b894;
            --accent: #6c5ce7;
            --text-dark: #1e293b;
            --text-gray: #64748b;
            --bg-light: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar - Persona Switcher */
        .top-bar {
            background: #1e293b;
            color: white;
            padding: 0 24px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }

        .persona-selector select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }

        .persona-selector select option {
            color: black;
        }

        /* Main Header */
        header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            z-index: 20;
        }

        .brand {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Layout Grid */
        .main-container {
            flex: 1;
            display: grid;
            grid-template-rows: auto 1fr;
            /* Journey Area vs Editor */
            overflow: hidden;
        }

        /* --- 1. PATIENT JOURNEY SECTION (Interactive) --- */
        .journey-section {
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
            overflow-y: auto;
            max-height: 40vh;
            /* Takes up top 40% */
            padding: 24px;
            position: relative;
        }

        /* Back Bar for Deep Dive */
        .back-bar {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            color: #b45309;
            padding: 8px 16px;
            margin-bottom: 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            /* hidden by default */
            align-items: center;
            gap: 8px;
            cursor: pointer;
            width: fit-content;
        }

        .back-bar:hover {
            background: #fef3c7;
        }

        /* Return to Active Tasks Bar (Context Switch) */
        .return-task-bar {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0369a1;
            padding: 8px 16px;
            margin-bottom: 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            /* hidden by default */
            align-items: center;
            gap: 8px;
            cursor: pointer;
            width: fit-content;
        }

        .return-task-bar:hover {
            background: #e0f2fe;
        }

        .journey-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Timeline Components */
        .date-group {
            display: flex;
            margin-bottom: 32px;
            position: relative;
        }

        .date-axis {
            width: 120px;
            flex-shrink: 0;
            border-right: 2px solid #cbd5e1;
            padding-right: 20px;
            text-align: right;
            position: relative;
        }

        .date-axis::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -6px;
            width: 10px;
            height: 10px;
            background: #cbd5e1;
            border-radius: 50%;
            border: 2px solid var(--bg-light);
        }

        .date-label {
            font-weight: 700;
            font-size: 14px;
            color: var(--text-dark);
        }

        .time-label {
            font-size: 12px;
            color: var(--text-gray);
        }

        .event-graph {
            flex: 1;
            padding-left: 32px;
            display: flex;
            align-items: center;
            overflow-x: auto;
        }

        .node-connector {
            flex-grow: 1;
            height: 2px;
            background: #cbd5e1;
            min-width: 40px;
            max-width: 80px;
            position: relative;
        }

        .node-connector::after {
            content: '‚ñ∫';
            position: absolute;
            right: -5px;
            top: -7px;
            font-size: 10px;
            color: #cbd5e1;
        }

        .graph-node {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            min-width: 140px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .graph-node:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .graph-node.active {
            border-color: var(--primary);
            background: #f0f9ff;
            box-shadow: 0 4px 12px rgba(15, 76, 129, 0.15);
        }

        .graph-node.viewing {
            border-color: #f59e0b;
            /* Amber */
            background: #fffbeb;
            box-shadow: 0 0 0 2px #fcd34d;
        }

        .node-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .node-details h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .node-details p {
            font-size: 11px;
            color: var(--text-gray);
        }

        /* Comparison Overlay */
        .comparison-overlay {
            margin-top: 12px;
            padding: 16px;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .compare-label {
            font-size: 11px;
            font-weight: 700;
            color: #d97706;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- 2. WORKSPACE / EDITOR SECTION --- */
        .workspace {
            display: grid;
            grid-template-columns: 1fr 340px;
            /* Editor vs Intelligence Sidebar */
            overflow: hidden;
            background: var(--white);
            border-top: 1px solid var(--border);
        }

        .editor-container {
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            overflow-y: auto;
        }

        .editor-box {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .box-header {
            padding: 12px 16px;
            background: white;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        textarea.raw-text {
            flex: 1;
            padding: 16px;
            border: none;
            resize: none;
            outline: none;
            font-size: 14px;
            line-height: 1.6;
            background: transparent;
            color: #334155;
        }

        .structured-view {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }

        .structured-view h3 {
            color: var(--primary);
            font-size: 13px;
            margin: 16px 0 4px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 2px;
        }

        .structured-view h3:first-child {
            margin-top: 0;
        }

        .structured-view p {
            margin-bottom: 8px;
            color: #475569;
        }

        /* Sidebar */
        .sidebar {
            border-left: 1px solid var(--border);
            background: #fcfcfc;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 14px;
        }

        .card-list {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        .similar-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .similar-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .match-badge {
            display: inline-block;
            background: #dcfce7;
            color: #166534;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .btn-format {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-format:hover {
            opacity: 0.9;
        }

        .btn-outline-sm {
            background: white;
            border: 1px solid var(--border);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
            color: var(--primary);
            font-weight: 600;
        }

        .btn-outline-sm:hover {
            border-color: var(--primary);
        }

        /* READ ONLY REPORT VIEW STYLES */
        .readonly-meds {
            padding: 16px;
        }

        .med-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .med-icon {
            color: var(--secondary);
        }

        .med-name {
            font-weight: 600;
            font-size: 13px;
        }

        .med-dose {
            font-size: 11px;
            color: var(--text-gray);
        }

        /* Pitch Footer */
        .pitch-footer {
            background: #1e293b;
            color: white;
            padding: 40px 24px;
            flex-shrink: 0;
            display: none;
            /* Hidden by default */
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .pitch-column h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #94a3b8;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .pitch-column h2 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: white;
        }

        .pitch-column p {
            font-size: 13px;
            line-height: 1.5;
            color: #cbd5e1;
            font-style: italic;
            border-left: 3px solid var(--primary);
            padding-left: 12px;
        }
    </style>
</head>

<body>

    <!-- 1. Top Bar: Persona Switcher -->
    <div class="top-bar">
        <div style="opacity: 0.8;">Demo Mode: Multi-Persona Evaluation</div>
        <div style="flex:1; display:flex; justify-content:center;">
            <button onclick="togglePitch()"
                style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; padding:4px 12px; border-radius:12px; font-size:11px; cursor:pointer;"
                onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fa-solid fa-lightbulb"></i> Our Vision
            </button>
        </div>
        <div class="persona-selector">
            <span>Viewing as: </span>
            <select id="personaSelect" onchange="switchPersona()">
                <option value="doctor">üë®‚Äç‚öïÔ∏è Doctor (Dr. Rao - Ortho)</option>
                <option value="radiologist">‚ò¢Ô∏è Radiologist (Dr. Khan - Neuro)</option>
                <option value="nurse">ü©∫ Nurse (Amit - Ward A)</option>
            </select>
        </div>
    </div>

    <!-- 2. Header: Patient Context -->
    <header>
        <div class="brand">
            <i class="fa-solid fa-user-doctor"></i> AI for Clinicians
        </div>

        <div style="display:flex; align-items:center; gap:20px;">
            <div style="text-align:right;">
                <h3 id="patientName" style="font-size:16px; font-weight:700;">Vikram Singh</h3>
                <p id="patientMeta" style="font-size:12px; color:var(--text-gray);">45M ‚Ä¢ Inpatient ‚Ä¢ Post-Op Day 1</p>
            </div>
            <div class="avatar-circle" id="patientAvatar"
                style="width:40px; height:40px; background:var(--primary-light); color:var(--primary); display:flex; align-items:center; justify-content:center; border-radius:50%; font-weight:700;">
                VS</div>
        </div>
    </header>

    <div class="main-container">

        <!-- 3. Journey Graph -->
        <div class="journey-section">

            <!-- Context Bars -->
            <div id="backBar" class="back-bar" onclick="restoreOriginalPatient()">
                <i class="fa-solid fa-arrow-left"></i> Return to Original Case
            </div>

            <div id="returnTaskBar" class="return-task-bar" onclick="closeDetails()">
                <i class="fa-solid fa-pen-to-square"></i> Close & Return to Active Note
            </div>

            <div class="journey-title">
                <span><i class="fa-solid fa-timeline"></i> Patient Journey Graph</span>
                <span class="badge"
                    style="background:#e0f2fe; color:#0369a1; padding:4px 8px; border-radius:4px; font-size:11px;">Live
                    View</span>
            </div>

            <div id="graphContainer">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- 4. Workspace -->
        <div class="workspace">
            <div class="editor-container" id="editorArea">
                <!-- Left: Rough Notes OR Meds -->
                <div class="editor-box">
                    <div class="box-header">
                        <span id="inputLabel"><i class="fa-solid fa-keyboard"></i> Dictation / Rough Notes</span>
                    </div>
                    <!-- Mode A: Text Input -->
                    <textarea id="rawInput" class="raw-text" placeholder="Start typing or dictating..."></textarea>
                    <!-- Mode B: Med List (Hidden by default) -->
                    <div id="medListContainer" class="readonly-meds"
                        style="display:none; flex:1; overflow-y:auto; background:#f8fafc;"></div>
                </div>

                <!-- Right: AI Formatting OR Full Report -->
                <div class="editor-box">
                    <div class="box-header">
                        <span id="outputLabel"><i class="fa-solid fa-file-medical"></i> Structured Output</span>
                        <button id="aiBtn" class="btn-format" onclick="runAIFormatter()">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> AI Format
                        </button>
                    </div>
                    <div id="aiOutput" class="structured-view">
                        <div style="color:#94a3b8; text-align:center; padding-top:60px;">
                            Waiting for input...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intelligence Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <i class="fa-solid fa-layer-group"></i> Similar Cases
                </div>
                <div class="card-list" id="similarList">
                    <!-- Cards injected by JS -->
                </div>
            </div>
        </div>

    </div>

    <!-- Pitch Section -->
    <section class="pitch-footer">
        <div class="pitch-column">
            <h3>The Vision</h3>
            <h2>Intelligence, Not Input</h2>
            <p>"Clinicians need an HMS that understands their data, not one that just feeds on it."</p>
        </div>
        <div class="pitch-column">
            <h3>The Impact</h3>
            <h2>Solving the Non-Productive</h2>
            <p>"We eliminate the documentation drudgery and endless searching that causes burnout."</p>
        </div>
        <div class="pitch-column">
            <h3>Why Us</h3>
            <h2>Deep Field Expertise</h2>
            <p>"We execute because we know this field: Proven US Healthcare AI expertise (GenAI) backed by Advanced
                Research at NIT Calicut."</p>
        </div>
    </section>

    <!-- JavaScript Logic -->
    <script>
        const personas = {
            doctor: {
                patient: "Vikram Singh",
                meta: "45M ‚Ä¢ Inpatient ‚Ä¢ Post-Op Day 1",
                initials: "VS",
                inputLabel: "Operative Note Dictation (Rough)",
                outputLabel: "Operative Note (FHIR)",
                rawText: "Right tibial plateau fracture. Spinal anesthesia. Tourniquet 300mmHg. Lateral approach. Reduction done. Plate fixed with 4 locking screws. Stable. Closed in layers.",
                journey: `
                    <div class="date-group">
                        <div class="date-axis"><div class="date-label">Dec 10</div><div class="time-label">Admission</div></div>
                        <div class="event-graph">
                            <div class="graph-node" onclick="viewEvent('doc_triage')">
                                <div class="node-icon"><i class="fa-solid fa-ambulance"></i></div>
                                <div class="node-details"><h4>ED Triage</h4><p>Acute Trauma</p></div>
                            </div>
                            <div class="node-connector"></div>
                            <div class="graph-node" onclick="viewEvent('doc_xray')">
                                <div class="node-icon"><i class="fa-solid fa-x-ray"></i></div>
                                <div class="node-details"><h4>Radiology</h4><p>X-Ray Knee</p></div>
                            </div>
                        </div>
                    </div>
                    <div class="date-group">
                        <div class="date-axis"><div class="date-label">Today</div><div class="time-label">Surgery</div></div>
                        <div class="event-graph">
                             <div class="graph-node active" onclick="viewEvent('doc_surg')">
                                <div class="node-icon"><i class="fa-solid fa-scalpel-line-dashed"></i></div>
                                <div class="node-details"><h4>OR 3</h4><p>ORIF Surgery</p></div>
                            </div>
                             <div class="node-connector"></div>
                             <div class="graph-node" onclick="viewEvent('doc_pacu')">
                                <div class="node-icon"><i class="fa-solid fa-person-walking-dashed-line-arrow-right"></i></div>
                                <div class="node-details"><h4>PACU</h4><p>Recovery</p></div>
                            </div>
                        </div>
                    </div>
                `,
                // DETAIL DATA FOR NODES
                events: {
                    'doc_triage': {
                        title: "ED Clinical Note",
                        meds: [
                            { name: "Morphine", dose: "5mg", route: "IV Push", time: "10:15" },
                            { name: "Tetanus Toxoid", dose: "0.5ml", route: "IM", time: "10:20" }
                        ],
                        report: "<h3>Chief Complaint</h3> <p>Severe right knee pain following motorcycle accident.</p> <h3>Physical Exam</h3> <p>Swelling +, Deformity +, Neurovascularly intact.</p>"
                    },
                    'doc_xray': {
                        title: "Radiology Report - XR Knee",
                        meds: [],
                        report: "<h3>Findings</h3> <p>Comminuted fracture of the lateral tibial plateau (Schatzker T2).</p> <h3>Impression</h3> <p>Tibial Plateau Fracture requiring ORIF.</p>"
                    },
                    'doc_surg': {
                        title: "Operative Report (Current)",
                        meds: [
                            { name: "Cefazolin", dose: "2g", route: "IV", time: "Pre-Op" },
                            { name: "Propofol", dose: "150mg", route: "IV", time: "Induction" },
                            { name: "Fentanyl", dose: "100mcg", route: "IV", time: "Intra-op" }
                        ],
                        report: "<h3>Procedure</h3> <p>ORIF Right Tibia.</p> <h3>Technique</h3> <p>Standard lateral approach. Reduction achieved. Fixed with LCP.</p>"
                    },
                    'doc_pacu': {
                        title: "PACU Flowsheet",
                        meds: [
                            { name: "Ondansetron", dose: "4mg", route: "IV", time: "14:00" },
                            { name: "Paracetamol", dose: "1g", route: "IV", time: "14:15" }
                        ],
                        report: "<h3>Course</h3> <p>Patient extubated. Stable. Pain well controlled.</p>"
                    }
                },
                similar: [
                    { id: "rajesh", name: "Rajesh K.", type: "Tibial #", match: "95%", note: "Excellent range of motion at 6 weeks.", fullJourney: `<div style="padding:20px;">Full graph for Rajesh...</div>` }
                ],
                // DOCTOR AI LOGIC (HIGH FIDELITY)
                aiLogic: (text) => `
                    <h3>Pre-Operative Diagnosis</h3> <p>Right tibial plateau fracture (Schatzker Type II).</p>
                    <h3>Post-Operative Diagnosis</h3> <p>Right tibial plateau fracture (Schatzker Type II).</p>
                    
                    <h3>Procedure</h3> <p>Open Reduction and Internal Fixation (ORIF) of Right Tibial Plateau.</p>
                    
                    <h3>Surgeon</h3> <p>Dr. A. Rao</p>
                    <h3>Anesthesia</h3> <p>Spinal Anesthesia</p>
                    
                    <h3>Operative Details</h3>
                    <p>The patient was taken to the operating room and placed in the supine position. Spinal anesthesia was administered. A tourniquet was applied and inflated to <strong>300 mmHg</strong>.</p>
                    <p>A <strong>standard lateral approach</strong> was utilized. The fracture site was exposed. Anatomic <strong>reduction was achieved</strong> and held with provisional K-wires.</p>
                    <p>Fixation was accomplished using a <strong>LCP plate with 4 locking screws</strong>. Stability was confirmed under C-arm. </p>
                    
                    <h3>Closure</h3> <p>The wound was <strong>closed in layers</strong>. Sterile dressing applied.</p>
                    
                    <h3>Plan</h3> <p>Admit to post-op ward. Elevate limb. Vitals monitering.</p>
                `
            },

            // RADIOLOGIST DATA
            radiologist: {
                patient: "Sarah Connor",
                meta: "32F ‚Ä¢ ED ‚Ä¢ Headache",
                initials: "SC",
                inputLabel: "Radiology Dictation (Key Phrases)",
                outputLabel: "CT Head Report (Final)",
                rawText: "CT Head without contrast. No acute intracranial hemorrhage. Ventricles are normal size. Midline is centered. No mass effect. Basal cisterns patent. No calvarial fracture.",
                journey: `
                     <div class="date-group">
                        <div class="date-axis"><div class="date-label">Today</div></div>
                        <div class="event-graph">
                             <div class="graph-node" onclick="viewEvent('rad_ed')">
                                <div class="node-icon"><i class="fa-solid fa-user-injured"></i></div>
                                <div class="node-details"><h4>ED Walk-in</h4><p>Headache</p></div>
                            </div>
                             <div class="node-connector"></div>
                             <div class="graph-node active" onclick="viewEvent('rad_ct')">
                                <div class="node-icon"><i class="fa-solid fa-radiation"></i></div>
                                <div class="node-details"><h4>CT Scan</h4><p>Brain</p></div>
                            </div>
                        </div>
                    </div>
                `,
                events: {
                    'rad_ed': { title: "ED Note", meds: [{ name: "Metoclopramide", dose: "10mg", route: "IV", time: "09:10" }], report: "<h3>HPI</h3><p>Worst headache of life.</p>" },
                    'rad_ct': { title: "CT Report (Draft)", meds: [], report: "<h3>Findings</h3><p>No acute bleed. Normal.</p>" }
                },
                similar: [{ id: "priya", name: "Priya M.", type: "Migraine", match: "92%", note: "Negative CT." }],
                // RADIOLOGIST AI LOGIC (HIGH FIDELITY)
                aiLogic: (text) => `
                    <h3>Clinical History</h3> <p>Severe headache. Rule out intracranial pathology.</p>
                    
                    <h3>Technique</h3> <p><strong>Axial CT images</strong> of the brain were obtained without intravenous contrast.</p>
                    
                    <h3>Comparison</h3> <p>None available.</p>
                    
                    <h3>Findings</h3>
                    <p><strong>Brain Parenchyma:</strong> There is normal gray-white matter differentiation. <strong>No acute intracranial hemorrhage</strong>, acute infarction, or space-occupying lesion is identified.</p>
                    <p><strong>Ventricles and Extra-axial Spaces:</strong> The <strong>ventricles are normal in size</strong> and configuration. The <strong>midline is centered</strong>. <strong>No midline shift</strong> or mass effect. Basal cisterns are patent. No subdural or epidural collection.</p>
                    <p><strong>Osseous Structures:</strong> <strong>No calvarial fracture</strong>. The visualized paranasal sinuses and mastoid air cells are clear.</p>
                    
                    <h3>Impression</h3> <p>1. Unremarkable non-contrast CT head.<br>2. <strong>No acute intracranial abnormality.</strong></p>
                `
            },

            // NURSE DATA
            nurse: {
                patient: "Amit Patel",
                meta: "60M ‚Ä¢ Ward 4",
                initials: "AP",
                inputLabel: "Nursing Notes (Shorthand)",
                outputLabel: "Inpatient Progress Note (SOAP)",
                rawText: "Pt stable. Pain 4/10. Meds given. Dressing checked dry and intact. Ambulating with walker. voiding qs.",
                journey: `
                    <div class="date-group">
                        <div class="date-axis"><div class="date-label">Today</div></div>
                        <div class="event-graph">
                             <div class="graph-node" onclick="viewEvent('nurse_meds')">
                                <div class="node-icon"><i class="fa-solid fa-pills"></i></div>
                                <div class="node-details"><h4>Meds</h4><p>Given</p></div>
                            </div>
                             <div class="node-connector"></div>
                             <div class="graph-node active" onclick="viewEvent('nurse_rounds')">
                                <div class="node-icon"><i class="fa-solid fa-clipboard-user"></i></div>
                                <div class="node-details"><h4>Rounds</h4><p>Vitals</p></div>
                            </div>
                        </div>
                    </div>
                `,
                events: {
                    'nurse_meds': { title: "MAR", meds: [{ name: "Tramadol", dose: "500mg", route: "PO", time: "08:00" }, { name: "Pantoprazole", dose: "40mg", route: "PO", time: "08:00" }], report: "<h3>Status</h3><p>Meds administered.</p>" },
                    'nurse_rounds': { title: "Nursing Note", meds: [], report: "<h3>Vitals</h3><p>BP 120/80, HR 80.</p>" }
                },
                similar: [{ id: "bob", name: "Bob W.", type: "Post-Op", match: "99%", note: "Protocol." }],
                // NURSE AI LOGIC (HIGH FIDELITY)
                aiLogic: (text) => `
                    <h3>Subjective</h3> 
                    <p>Patient states he feels <strong>stable</strong>. Reports pain level is controlled at <strong>4/10</strong>.</p>
                    
                    <h3>Objective</h3>
                    <p><strong>Vitals:</strong> BP: 124/82 mmHg | HR: 78 bpm | RR: 18 | SpO2: 98% RA.</p>
                    <p><strong>Incision:</strong> Surgical <strong>dressing checked; dry and intact</strong>. No signs of soakage.</p>
                    <p><strong>Activity:</strong> Patient is <strong>ambulating with walker</strong> assistance.</p>
                    <p><strong>Output:</strong> Voiding quantity sufficient (QS).</p>
                    
                    <h3>Assessment</h3> <p>Post-operative course stable. Pain management effective. Mobility improving.</p>
                    
                    <h3>Plan</h3> 
                    <p>1. Continue scheduled medications (<strong>Meds given</strong>).<br>2. Encourage mobilization.<br>3. Monitor vitals q4h.</p>
                `
            }
        };

        let currentPersona = 'doctor';
        let originalPatientData = null;
        let activeData = null; // Track currently displayed patient

        function switchPersona() {
            currentPersona = document.getElementById('personaSelect').value;
            originalPatientData = null;
            document.getElementById('backBar').style.display = 'none';
            document.getElementById('returnTaskBar').style.display = 'none';
            render();
        }

        // Main Render Logic
        function render(overrideData = null) {
            const data = overrideData || personas[currentPersona];
            activeData = data; // Set global reference

            // Header
            document.getElementById('patientName').innerText = data.patient;
            document.getElementById('patientMeta').innerText = data.meta;
            document.getElementById('patientAvatar').innerText = data.initials || "PT";

            // Default Editor State (Reset or Override)
            if (!overrideData) {
                document.getElementById('inputLabel').innerHTML = `<i class="fa-solid fa-keyboard"></i> ${data.inputLabel}`;
                document.getElementById('outputLabel').innerHTML = `<i class="fa-solid fa-file-medical"></i> ${data.outputLabel}`;
                document.getElementById('rawInput').style.display = 'block';
                document.getElementById('rawInput').value = data.rawText;
                document.getElementById('medListContainer').style.display = 'none';
                document.getElementById('aiOutput').innerHTML = '<div style="color:#94a3b8; text-align:center; padding-top:60px;">Click AI Format to process...</div>';
                document.getElementById('aiBtn').style.display = 'flex';
            } else {
                // VIEWING HISTORICAL PATIENT
                document.getElementById('inputLabel').innerHTML = `<i class="fa-solid fa-info-circle"></i> Historical Summary`;
                document.getElementById('outputLabel').innerHTML = `<i class="fa-solid fa-file-invoice"></i> Outcome Note`;
                document.getElementById('rawInput').style.display = 'none';
                document.getElementById('medListContainer').style.display = 'block';
                document.getElementById('medListContainer').innerHTML = `<div style="padding:20px; color:#666; font-size:13px; line-height:1.5;">${data.meta}<br><br><strong>Primary Doctor:</strong> Dr. A. Rao<br><strong>Status:</strong> Discharged</div>`;

                document.getElementById('aiBtn').style.display = 'none';
                document.getElementById('aiOutput').innerHTML = data.summary || "<p>No detailed report available.</p>";
            }

            // Graph
            document.getElementById('graphContainer').innerHTML = data.journey || data.fullJourney;

            // Similar Cases (Only if not deep diving)
            const list = document.getElementById('similarList');
            if (overrideData) {
                list.innerHTML = `<div style="padding:20px; color:#666; text-align:center;">Viewing Related Patient...</div>`;
            } else {
                list.innerHTML = '';
                data.similar.forEach((item) => {
                    const card = document.createElement('div');
                    card.className = 'similar-card';
                    card.innerHTML = `
                        <div class="match-badge">${item.match} Match</div>
                        <div style="font-weight:600; font-size:13px;" onclick="toggleComparison(this)">${item.name}</div>
                        <div style="font-size:11px; color:#64748b;" onclick="toggleComparison(this)">${item.type}</div>
                        <div class="comparison-overlay">
                            <div class="compare-label">
                                <span><i class="fa-solid fa-code-compare"></i> Comparing Journey</span>
                            </div>
                            <!-- RESTORED MINI-GRAPH -->
                            <div class="event-graph" style="padding-left:0; overflow:hidden; margin-bottom:8px;">
                                <div class="graph-node" style="padding:6px; min-width:80px; transform:scale(0.9);">
                                    <div class="node-icon" style="width:20px; height:20px; font-size:10px;"><i class="fa-solid fa-user-injured"></i></div>
                                    <div class="node-details"><h4 style="font-size:10px;">Admit</h4></div>
                                </div>
                                <div class="node-connector" style="min-width:15px;"></div>
                                <div class="graph-node" style="padding:6px; min-width:80px; transform:scale(0.9);">
                                    <div class="node-icon" style="width:20px; height:20px; font-size:10px;"><i class="fa-solid fa-check"></i></div>
                                    <div class="node-details"><h4 style="font-size:10px;">Done</h4></div>
                                </div>
                            </div>
                            <div style="font-size:11px; color:#333;"><strong>Outcome:</strong> ${item.note}</div>
                            <button class="btn-outline-sm" onclick="viewRelatedPatient('${item.id}')">View Full Journey</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            }
        }

        // VIEW EVENT DETAILS (User Request v5)
        function viewEvent(eventId) {
            // FIX: Use activeData instead of hardcoded persona
            const data = activeData || personas[currentPersona];
            const event = data.events ? data.events[eventId] : null;

            if (!event) return;

            // 1. Show Return Bar
            document.getElementById('returnTaskBar').style.display = 'flex';

            // 2. Setup Left Pane (Meds)
            document.getElementById('inputLabel').innerHTML = `<i class="fa-solid fa-pills"></i> Medications Administered`;
            document.getElementById('rawInput').style.display = 'none'; // Hide text area
            const medContainer = document.getElementById('medListContainer');
            medContainer.style.display = 'block';

            if (event.meds && event.meds.length > 0) {
                // ENHANCED MED DISPLAY
                medContainer.innerHTML = event.meds.map(m => `
                    <div class="med-item">
                        <div class="med-icon"><i class="fa-solid fa-prescription-bottle-medical"></i></div>
                        <div style="flex:1;">
                            <div class="med-name">${m.name} <span style="font-weight:400; color:#666;">${m.dose}</span></div>
                            <div class="med-dose">${m.route} ‚Ä¢ Given at ${m.time}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                medContainer.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">No medications recorded for this event.</div>';
            }

            // 3. Setup Right Pane (Report)
            document.getElementById('outputLabel').innerHTML = `<i class="fa-solid fa-file-invoice"></i> ${event.title}`;
            document.getElementById('aiBtn').style.display = 'none'; // Hide AI button
            document.getElementById('aiOutput').innerHTML = event.report;

            // 4. Highlight Graph Node (Visual feedback)
            // Reset others
            document.querySelectorAll('.graph-node').forEach(n => n.classList.remove('viewing'));
            // This is a simple hack since we passed the ID, in production we'd bind properly. 
            // For now, let's just assume the user clicked it so event.target logic handled the animation naturally? 
            // Better: Find the node with the onclick matching.
            const nodes = document.querySelectorAll('.graph-node');
            nodes.forEach(n => {
                if (n.getAttribute('onclick').includes(eventId)) {
                    n.classList.add('viewing');
                }
            });
        }

        function closeDetails() {
            document.getElementById('returnTaskBar').style.display = 'none';
            document.querySelectorAll('.graph-node').forEach(n => n.classList.remove('viewing'));
            render(); // Re-render default state
        }

        function toggleComparison(el) {
            const overlay = el.parentElement.querySelector('.comparison-overlay');
            overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
        }

        function viewRelatedPatient(id) {
            originalPatientData = personas[currentPersona];
            const related = originalPatientData.similar.find(r => r.id === id);
            if (!related) return;

            document.getElementById('backBar').style.display = 'flex';
            render({
                patient: related.name,
                meta: "Historical ‚Ä¢ " + related.type,
                initials: "PT",
                fullJourney: `
                     <div class="date-group">
                        <div class="date-axis"><div class="date-label">Month 1</div><div class="time-label">Acute</div></div>
                         <div class="event-graph">
                            <div class="graph-node" onclick="viewEvent('hist_admit')">
                                <div class="node-icon"><i class="fa-solid fa-truck-medical"></i></div>
                                <div class="node-details"><h4>Admission</h4><p>Trauma Ctr</p></div>
                            </div>
                            <div class="node-connector"></div>
                             <div class="graph-node" onclick="viewEvent('hist_surg')">
                                <div class="node-icon"><i class="fa-solid fa-user-doctor"></i></div>
                                <div class="node-details"><h4>Surgery</h4><p>ORIF Fixed</p></div>
                            </div>
                        </div>
                     </div>
                     <div class="date-group">
                        <div class="date-axis"><div class="date-label" style="color:#059669;">Month 2</div><div class="time-label">Rehab</div></div>
                         <div class="event-graph">
                            <div class="graph-node" onclick="viewEvent('hist_pt')">
                                <div class="node-icon"><i class="fa-solid fa-person-walking"></i></div>
                                <div class="node-details"><h4>PT Session</h4><p>Gait Training</p></div>
                            </div>
                            <div class="node-connector"></div>
                             <div class="graph-node active" onclick="viewEvent('hist_discharge')">
                                <div class="node-icon"><i class="fa-solid fa-check-double"></i></div>
                                <div class="node-details"><h4>Discharge</h4><p>Full Recovery</p></div>
                            </div>
                        </div>
                     </div>`,
                summary: "<h3>Clinical Outcome</h3><p>Patient achieved full weight bearing at 6 weeks. Range of motion 0-120 degrees.</p><p><strong>Complications:</strong> None.</p><p><strong>Return to Work:</strong> Approved for light duty.</p>",
                events: {
                    'hist_admit': { title: "Admission Note", meds: [{ name: "Morphine", dose: "5mg", route: "IV", time: "09:00" }], report: "<h3>History</h3><p>Patient admitted via ER following motorcycle collision.</p>" },
                    'hist_surg': { title: "Operative Note", meds: [{ name: "Anesthesia", dose: "General", route: "Inhaled", time: "10:00" }], report: "<h3>Procedure</h3><p>ORIF Right Tibia Plateau. Hardware placed.</p>" },
                    'hist_pt': { title: "PT Progress Note", meds: [], report: "<h3>Assessment</h3><p>Gait Analysis: Antalgic gait improving. Weight bearing as tolerated.</p>" },
                    'hist_discharge': { title: "Discharge Summary", meds: [{ name: "Ibuprofen", dose: "400mg", route: "PO", time: "Discharge" }], report: "<h3>Plan</h3><p>Discharged to home. Follow up in 2 weeks.</p>" }
                }
            });
        }

        function restoreOriginalPatient() {
            document.getElementById('backBar').style.display = 'none';
            render();
        }

        function togglePitch() {
            const footer = document.querySelector('.pitch-footer');
            if (footer.style.display === 'grid') {
                footer.style.display = 'none';
                // optional: scroll to top
            } else {
                footer.style.display = 'grid';
                footer.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function runAIFormatter() {
            const data = personas[currentPersona];
            const out = document.getElementById('aiOutput');
            out.innerHTML = '<div style="color:var(--primary); text-align:center; padding-top:60px;"><i class="fa-solid fa-spinner fa-spin"></i> Generating Detailed Report...</div>';
            setTimeout(() => out.innerHTML = data.aiLogic(document.getElementById('rawInput').value), 1200);
        }

        render();
    </script>
</body>

</html>